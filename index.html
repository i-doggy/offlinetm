<!DOCTYPE HTML>
<html manifest='tm.cache'>
	<head>
		<title>Your tasks</title>
		<link rel='stylesheet' href='style.css'>
	</head>
	<body>
		<!--section>
			<h1>Your task list</h1>
			<progress max=7 value=4></progress>
			<ul>
				<li class='taskgroup'>
					<section>
						<h1><input value='Group Name'></h1>
						<progress max=7 value=4></progress>
						<ul>
							<li class='task checked'>Task Name11</li>
							<li class='task'>Task Name12</li>
							<li class='task'>Task Name13</li>
							<li class='task checked'>Task Name14</li>
							<li class='task'>Task Name15</li>
							<li class='task checked'>Task Name16</li>
							<li class='task'>Task Name17</li>
							<li class='plus'>+</li>
						</ul>
					</section>
				</li>
				<li class='task'>Task Name2</li>
				<li>
					<section>
						<h1><input value='Group Name'></h1>
						<progress max=7 value=4></progress>
						<ul>
							<li class='task checked'><div class='checkbox'><span>&#x2713;<span></div><span contenteditable>Task Name31</span><div class='deletebox'>&#x274C;</div></li>
							<li class='task checked'><div class='checkbox'><span>&#x2713;<span></div><span contenteditable>Task Name32</span><div class='deletebox'>&#x274C;</div></li>
							<li class='task checked'><div class='checkbox'><span>&#x2713;<span></div><span contenteditable>Task Name33</span><div class='deletebox'>&#x274C;</div></li>
							<li class='plus'>+</li>
						</ul>
					</section>
				</li>
				<li class='plus'>+</li>
			</ul>
		</section-->
		<script src='pureClasses.js'></script>
		<script src='script.js'></script>
		<script defer>
			console.log(window.localStorage.getItem('index'));
			var saved = parseInt(window.localStorage.getItem('index'), 10);
			if(saved) {
				var i = 0;
				for(;i < saved; i++) {
					var z = window.localStorage.getItem(i.toString());
					if(z) {
						var l = loadSavedData(z);
						document.body.append(l.element);
					}
				}
			}
			else {
				var z = new RealTaskGroup('Group');
				document.body.append(z.element);
			}
			document.body.append(addNewList());
			
			document.body.onbeforeunload = function obu(e) {
				window.localStorage.clear();
				var save = [].filter.call(document.body.children, function(e) {
					return e.tagName == 'SECTION'; 
				}).map(function(e) { 
					return JSON.stringify(e.taskgroup.getSaveData());
				});
				save.forEach(function(e, i) { window.localStorage.setItem(i.toString(), e); });
				window.localStorage.setItem('index', save.length);
				console.log('huina');
			};
			
			function addNewList() {
				var s = document.createElement('DIV');
				s.innerText = 'Add new list';
				s.classList.add('newlist');
				return s;
			}
		
			/*var ad = false;
			var constr = RealTask;
			var constr2 = RealTaskGroup;
			var mt = ['task1', 'task2', 'task3'].map(function(e) { return new constr(e); });
			var mt2 = ['task4', 'task5', 'task6'].map(function(e) { return new constr(e, ad); });
			
			var subgroup = new constr2('group2', mt2[0], mt2[1], mt2[2]);
			var v = new constr2('group1', mt[0], mt[1], mt[2], subgroup);
			document.body.append(v.element);*/
			
			document.body.addEventListener('dragstart', function(e) {
				e.target.id = '__drag__';
				//e.dataTransfer.setData('text', '__drag__');
			});
			document.body.addEventListener('dragover', function(e) {
				if(e.target.closest('UL')) e.preventDefault();
			});
			document.body.addEventListener('drop', function(e) {
				if(e.target.tagName == 'UL') {
					e.preventDefault();
					e.target.append(document.getElementById('__drag__'));
				}
				var z = e.target.closest('li');
				if(z) {
					console.log(z);
					e.preventDefault();
					z.parentNode.insertBefore(document.getElementById('__drag__'), z);
				}
				document.getElementById('__drag__').id='';
			});
			
			document.body.addEventListener("keyup", function(event) {
			if(event.target.tagName == 'INPUT')
				if (event.keyCode == 13) {
					event.target.blur();
					event.target.parentNode.nextSibling.querySelector('INPUT').focus();
				}
			});
		</script>
	</body>
</html>